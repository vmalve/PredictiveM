<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IoT Predictive Maintenance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>IoT Predictive Maintenance Dashboard</h1>

  <label for="mode">Select Mode:</label>
  <select id="modeSelector">
    <option value="manual">Manual Input</option>
    <option value="auto">Auto Refresh IoT (Simulated)</option>
    <option value="iot-graph">Input with Graph (Real IoT)</option>
    <option value="desktop-graph">Input with Graph (Desktop)</option>
  </select>

  <div id="manual-form-container">
    <h2>Manual Input</h2>
    <form id="manualForm">
      <label>Voltage: <input type="number" step="any" name="voltage" required></label><br>
      <label>Current: <input type="number" step="any" name="current" required></label><br>
      <label>Temperature: <input type="number" step="any" name="temperature" required></label><br>
      <label>Power: <input type="number" step="any" name="power" required></label><br>
      <label>Vibration: <input type="number" step="any" name="vibration" required></label><br>
      <button type="submit">Submit</button>
    </form>
  </div>

  <div id="trend-container" style="display:none;">
    <h2>Live Prediction Trend</h2>
    <canvas id="trendChart" width="600" height="300"></canvas>
    <p>Prediction: <span id="prediction">N/A</span></p>
    <p>Probability: <span id="probability">N/A</span></p>
  </div>

  <script>
    const modeSelector = document.getElementById("modeSelector");
    const trendContainer = document.getElementById("trend-container");
    const ctx = document.getElementById("trendChart").getContext("2d");

    const probabilityData = {
      labels: [],
      datasets: [
        {
          label: 'Model Probability',
          data: [],
          borderColor: 'blue',
          fill: false,
        },
        {
          label: 'Threshold (0.5)',
          data: [],
          borderColor: 'red',
          borderDash: [5, 5],
          fill: false,
        }
      ]
    };

    const probabilityChart = new Chart(ctx, {
      type: 'line',
      data: probabilityData,
      options: {
        scales: {
          y: { beginAtZero: true, max: 1 }
        }
      }
    });

    function updateChart(data) {
      const timestamp = new Date().toLocaleTimeString();
      const prob = data.probability;

      document.getElementById("prediction").textContent = data.prediction;
      document.getElementById("probability").textContent = prob.toFixed(2);

      if (probabilityData.labels.length >= 20) {
        probabilityData.labels.shift();
        probabilityData.datasets[0].data.shift();
        probabilityData.datasets[1].data.shift();
      }

      probabilityData.labels.push(timestamp);
      probabilityData.datasets[0].data.push(prob);
      probabilityData.datasets[1].data.push(0.5);

      probabilityChart.update();
    }

    function fetchSimulatedIoT() {
      fetch('/get_prediction?source=simulated')
        .then(res => res.json())
        .then(updateChart);
    }

    function fetchRealIoT() {
      fetch('/get_prediction?source=iot')
        .then(res => res.json())
        .then(updateChart);
    }

    function fetchDesktopIoT() {
      fetch('/get_prediction?source=desktop')
        .then(res => res.json())
        .then(updateChart);
    }

    modeSelector.addEventListener("change", () => {
      const mode = modeSelector.value;
      clearInterval(window.autoInterval);

      document.getElementById("manual-form-container").style.display = mode === "manual" ? "block" : "none";
      trendContainer.style.display = mode === "manual" ? "none" : "block";

      if (mode === "auto") {
        fetchSimulatedIoT();
        window.autoInterval = setInterval(fetchSimulatedIoT, 5000);
      } else if (mode === "iot-graph") {
        fetchRealIoT();
        window.autoInterval = setInterval(fetchRealIoT, 5000);
      } else if (mode === "desktop-graph") {
        fetchDesktopIoT();
        window.autoInterval = setInterval(fetchDesktopIoT, 5000);
      }
    });

    window.addEventListener("beforeunload", () => clearInterval(window.autoInterval));

    // Handle manual form submit
    document.getElementById("manualForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const payload = {};
      formData.forEach((value, key) => payload[key] = parseFloat(value));

      fetch('/predict_manual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        alert(`Prediction: ${data.prediction}\nProbability: ${data.probability}`);
      });
    });

    // Trigger mode once on load
    modeSelector.dispatchEvent(new Event("change"));
  </script>
</body>
</html>
